require('dotenv').config();
const jwt = require('jsonwebtoken');
const { OAuth2Client } = require("google-auth-library");
const express = require("express");
const app = express();

const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

const cors = require("cors");

const FRONTEND_URL = process.env.FRONTEND_URL || "http://localhost:5173";
app.use(cors({
  origin: FRONTEND_URL,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));


const client = new OAuth2Client(process.env.GOOGLE_CLIENT_ID);
app.use(express.json({ limit: '50mb' }));

console.log(process.env.DATABASE_URL);

//middleware to authenticate a jwt token
function auth(req, res, next) {
  const header = req.headers.authorization;
  if (!header) return res.sendStatus(401);

  const token = header.split(" ")[1];

  try {
    req.user = jwt.verify(token, process.env.JWT_SECRET);
    next();
  } catch {
    res.sendStatus(401);
  }
}

app.get('/user/me', auth, async (req, res) => {
    try{
        if(req.user) {
            const user = await prisma.user.findUnique({
                where: {id: req.user.userId},
                select: {firstName: true}
            })
            return res.status(200).json({firstName: user.firstName});
        }
    }
    catch (err) {
        res.status(500).json({ error: err.message });
    }
})

app.post("/addEntry", auth, async (req, res) => {
    try {
        if(req.user) {
            //console.log(req.user);

            const user = await prisma.user.findUnique({
                where: {id: req.user.userId}
            })

            const {photo, rating, comments} = req.body;
            //console.log(req.body);

            const review = await prisma.review.create({
                data: {
                    userId: user.id,
                    photourl: photo,
                    rating: rating,
                    opinion: comments || null,
                    date: new Date()
                }
            })

            //console.log(review);
            return res.status(201).json({message: "New entry added"});
        }
    }
    catch (err) {
        console.error("Error creating review:", err);
        return res.status(500).json({error: err.message});
    }
})

app.post('/auth/google', async (req, res) => {
    const { credential, clientId } = req.body;
    console.log(req.body);

    try {
        const ticket = await client.verifyIdToken({
            idToken: credential,
            audience: clientId
        });

        console.log("ticket created");

        const payload = ticket.getPayload();

        if(!payload) {
            return res.status(400).json({error: "Invalid token payload"});
        }
        const {given_name, family_name, email, sub} = payload;

        console.log("payload extracted");
        console.log(payload);

        let user = await prisma.user.findUnique({
            where: { email: email }
        });
        
        console.log("user lookup done");

        if(!user) {
            user = await prisma.user.create({
                data: {
                    googleId: sub,
                    firstName: given_name,
                    lastName: family_name,
                    email: email
                }
            })

        }

        console.log("user found or created");
        //generate jwt token
        const appToken = jwt.sign(
            { userId: user.id },
            process.env.JWT_SECRET,
            { expiresIn: "7d" }
        );

        console.log("jwt created");
        
        res.json({
            success: true,
            token: appToken,
            user: {
                id: user.id,
                firstName: user.firstName,
                email: user.email,
            },
        });
    }
    catch(err) {
        console.log("error in /auth/google:", err);
        res.status(500).json({ success: false, message: err.message });
    }
})

app.get('/reviews', auth, async (req, res) => {
    try {
        const {folderId} = req.query;
        console.log("id: " + folderId);
        if(folderId) {
            console.log("problem");
            const found = await prisma.folder.findUnique({
                where: {id: parseInt(folderId)},
                include: {posts: { orderBy: { id: 'desc' } }}

            })
            console.log("problem here");
            console.log(found);
            if(found) {
                console.log("a folder has been found");
                console.log(found.posts);
                return res.status(200).json(found.posts);
            }
        }

        else {
            if(req.user) {
                const user = await prisma.user.findUnique({
                    where: {id: req.user.userId},
                    include: {review: { orderBy: { id: 'desc' } } }
                })
                if(user) {
                    return res.status(200).json(user.review);
                }
                else {
                    return res.status(404).json({error: "User not found"});
                }
            }
        }
    }
    catch (err) {
        res.status(500).json({ error: err.message });
    }
})

app.patch('/reviews/:id', async (req, res) => {
    try{
        const {id} = req.params;
        const {rating, comments} = req.body;
        console.log(req.body);

        const review = await prisma.review.findUnique({
            where: {id: parseInt(id)}
        })
        console.log("review found");
        console.log(review);
        if(review) {
            console.log("im here");
            const updated = await prisma.review.update({
                where: {id: parseInt(id)},
                data: {
                    rating,
                    opinion: comments || null
                }
            })
            console.log(updated);
            return res.status(200).json(updated);
        }
    }
    catch (err) {
        return res. status(500).json({error: err.message});
    }
})

app.post('/moveEntry/:name', auth, async (req, res) => {
    try {
        const {name} = req.params;
        const {reviewId} = req.body;

        console.log(name, reviewId);

        const folder = await prisma.folder.findUnique({
            where: {name: name},
            include: {posts: true}
        })

        console.log(folder);

        const review = await prisma.review.findUnique({
            where: {id: reviewId}
        })
        console.log(review);
        if(folder) {
            if(review) {
                //check if this review is already in this folder
                const exists = folder.posts.some((r) => r.id === review.id);
                if(!exists) {
                    const updatedReview = await prisma.review.update({
                        where: {id: reviewId},
                        data: {
                            folder: {
                                connect: {id: folder.id}
                            }
                        }
                    })

                    const updatedFolder = await prisma.folder.update({
                        where: {id: folder.id},
                        data: {
                            posts: {
                                connect: {id: review.id}
                            }
                        }
                    })
                    return res.status(200).json({message: "Review moved to folder"});
                }
                return res.status(400).json({error: "Review already in this folder"});
            }
        }
        else {
            return res.status(404).json({error: "Folder not found"});
        }
    }
    catch (err) {
        res.status(500).json({ error: err.message });
    }
})

app.post('/createFolder', auth, async (req, res) => {
    try {
        if(req.user) {
            const user = await prisma.user.findUnique({
                where: {id: req.user.userId}
            })
            console.log("found user");

            if(user) {
                console.log("user is authenticated")
                console.log(req.body);
                const {name} = req.body;

                console.log(req.body);
                const folder = await prisma.folder.create({
                    data: {name: name, userId: user.id}
                })
                return res.status(201).json({message: "Folder created", folderId: folder.name});
            }
            return res.status(404).json({error: "User not found"});
        }
    }
    catch (err) {
        res.status(500).json({ error: err.message });
    }
})

app.get('/folders', async (req, res) => {
    try {
        const folders = await prisma.folder.findMany();
        console.log(folders);
        return res.status(200).json(folders);
    }
    catch (err) {
        res.status(500).json({ error: err.message });
    }
})

app.listen(3000, () => {
    console.log('Server is running on port 3000');
})